
### [Dive Into Systems](../index-2.html) {#dive-into-systems .title}

-   -   [Dive Into Systems]{.nav-text}
        -   [Authors](../index-2.html){.nav-link}
        -   [Copyright](../copyright.html){.nav-link}
        -   [Acknowledgements](../acknowledgements.html){.nav-link}
        -   [Preface](../preface.html){.nav-link}
    -   [0. Introduction](../introduction.html){.nav-link}

-   -   [1. By the C, the Beautiful
        C](../C1-C_intro/index.html){.nav-link}
        -   [1.1. Getting Started Programming in
            C](../C1-C_intro/getting_started.html){.nav-link}
        -   [1.2. Input/Output (printf and
            scanf)](../C1-C_intro/input_output.html){.nav-link}
        -   [1.3. Conditionals and
            Loops](../C1-C_intro/conditionals.html){.nav-link}
        -   [1.4. Functions](../C1-C_intro/functions.html){.nav-link}
        -   [1.5. Arrays and
            Strings](../C1-C_intro/arrays_strings.html){.nav-link}
        -   [1.6. Structs](../C1-C_intro/structs.html){.nav-link}
        -   [1.7. Summary](../C1-C_intro/summary.html){.nav-link}
        -   [1.8. Exercises](../C1-C_intro/exercises.html){.nav-link}

-   -   [2. A Deeper Dive Into C](index.html){.nav-link}
        -   [2.1. Parts of Program Memory and
            Scope](scope_memory.html){.nav-link}
        -   [2.2. C Pointer Variables](pointers.html){.nav-link}
        -   [2.3. Pointers and
            Functions](pointers_functions.html){.nav-link}
        -   [2.4. Dynamic Memory
            Allocation](dynamic_memory.html){.nav-link}
        -   [2.5. Arrays in C](arrays.html){.nav-link}
        -   [2.6. Strings and the String
            Library](strings.html){.nav-link}
        -   [2.7. Structs](structs.html){.nav-link}
        -   [2.8. Input / Output in C](IO.html){.nav-link}
        -   [2.9. Advanced C Features](advanced.html){.nav-link}
            -   [2.9.1. Constants, switch, enum, and
                typedef](advanced_switch.html){.nav-link}
            -   [2.9.2. Command Line
                Arguments](advanced_cmd_line_args.html){.nav-link}
            -   [2.9.3. The void\*
                Type](advanced_voidstar.html){.nav-link}
            -   [2.9.4. Pointer
                Arithmetic](advanced_pointer_arithmetic.html){.nav-link}
            -   [2.9.5. C Libraries: Using, Compiling and
                Linking](advanced_libraries.html){.nav-link}
            -   [2.9.6. Writing and using your own C libraries (and
                compiling multiple .c and .h
                files)](advanced_writing_libraries.html){.nav-link}
            -   [2.9.7. Compiling C to Assembly and Compiling Assembly
                Code](advanced_assembly.html){.nav-link}
        -   [2.10. Summary](summary.html){.nav-link}
        -   [2.11. Exercises](exercises.html){.nav-link}

-   -   [3. C Debugging Tools](../C3-C_debug/index.html){.nav-link}
        -   [3.1. Debugging with GDB](../C3-C_debug/gdb.html){.nav-link}
        -   [3.2. GDB Commands in
            Detail](../C3-C_debug/gdb_commands.html){.nav-link}
        -   [3.3. Debugging Memory with
            Valgrind](../C3-C_debug/valgrind.html){.nav-link}
        -   [3.4. Advanced GDB
            Features](../C3-C_debug/gdb_advanced.html){.nav-link}
        -   [3.5. Debugging Assembly
            Code](../C3-C_debug/gdb_assembly.html){.nav-link}
        -   [3.6. Debugging Multi-threaded
            Programs](../C3-C_debug/gdb_pthreads.html){.nav-link}
        -   [3.7. Summary](../C3-C_debug/summary.html){.nav-link}

-   -   [11. Storage and the Memory
        Hierarchy](../C11-MemHierarchy/index.html){.nav-link}
        -   [11.1. The Memory
            Hierarchy](../C11-MemHierarchy/mem_hierarchy.html){.nav-link}
        -   [11.2. Storage
            Devices](../C11-MemHierarchy/devices.html){.nav-link}
        -   [11.3.
            Locality](../C11-MemHierarchy/locality.html){.nav-link}
        -   [11.4. Caching](../C11-MemHierarchy/caching.html){.nav-link}
        -   [11.5. Cache Analysis and
            Cachegrind](../C11-MemHierarchy/cachegrind.html){.nav-link}
        -   [11.6. Looking Ahead: Caching on Multicore
            Processors](../C11-MemHierarchy/coherency.html){.nav-link}
        -   [11.7. Summary](../C11-MemHierarchy/summary.html){.nav-link}
        -   [11.8.
            Exercises](../C11-MemHierarchy/exercises.html){.nav-link}

-   -   [12. Code Optimization](../C12-CodeOpt/index.html){.nav-link}
        -   [12.1. First Steps](../C12-CodeOpt/basic.html){.nav-link}
        -   [12.2. Other Compiler
            Optimizations](../C12-CodeOpt/loops_functions.html){.nav-link}
        -   [12.3. Memory
            Considerations](../C12-CodeOpt/memory_considerations.html){.nav-link}
        -   [12.4. Summary](../C12-CodeOpt/summary.html){.nav-link}

-   -   [13. The Operating System](../C13-OS/index.html){.nav-link}
        -   [13.1. Booting and Running](../C13-OS/impl.html){.nav-link}
        -   [13.2. Processes](../C13-OS/processes.html){.nav-link}
        -   [13.3. Virtual Memory](../C13-OS/vm.html){.nav-link}
        -   [13.4. Interprocess
            Communication](../C13-OS/ipc.html){.nav-link}
            -   [13.4.1. Signals](../C13-OS/ipc_signals.html){.nav-link}
            -   [13.4.2. Message
                Passing](../C13-OS/ipc_msging.html){.nav-link}
            -   [13.4.3. Shared
                Memory](../C13-OS/ipc_shm.html){.nav-link}
        -   [13.5. Summary and Other OS
            Functionality](../C13-OS/advanced.html){.nav-link}
        -   [13.6. Exercises](../C13-OS/exercises.html){.nav-link}

-   -   [14. Leveraging Shared Memory in the Multicore
        Era](../C14-SharedMemory/index.html){.nav-link}
        -   [14.1. Programming Multicore
            Systems](../C14-SharedMemory/multicore.html){.nav-link}
        -   [14.2. POSIX
            Threads](../C14-SharedMemory/posix.html){.nav-link}
        -   [14.3. Synchronizing
            Threads](../C14-SharedMemory/synchronization.html){.nav-link}
            -   [14.3.1. Mutual
                Exclusion](../C14-SharedMemory/mutex.html){.nav-link}
            -   [14.3.2.
                Semaphores](../C14-SharedMemory/semaphores.html){.nav-link}
            -   [14.3.3. Other Synchronization
                Constructs](../C14-SharedMemory/other_syncs.html){.nav-link}
        -   [14.4. Measuring Parallel
            Performance](../C14-SharedMemory/performance.html){.nav-link}
            -   [14.4.1. Parallel Performance
                Basics](../C14-SharedMemory/performance_basics.html){.nav-link}
            -   [14.4.2. Advanced
                Topics](../C14-SharedMemory/performance_advanced.html){.nav-link}
        -   [14.5. Cache
            Coherence](../C14-SharedMemory/cache_coherence.html){.nav-link}
        -   [14.6. Thread
            Safety](../C14-SharedMemory/thread_safety.html){.nav-link}
        -   [14.7. Implicit Threading with
            OpenMP](../C14-SharedMemory/openmp.html){.nav-link}
        -   [14.8. Summary](../C14-SharedMemory/summary.html){.nav-link}
        -   [14.9.
            Exercises](../C14-SharedMemory/exercises.html){.nav-link}

-   -   [15. Looking Ahead: Other Parallel
        Systems](../C15-Parallel/index.html){.nav-link}
        -   [15.1. Hardware Acceleration and
            CUDA](../C15-Parallel/gpu.html){.nav-link}
        -   [15.2. Distributed Memory
            Systems](../C15-Parallel/distrmem.html){.nav-link}
        -   [15.3. To Exascale and
            Beyond](../C15-Parallel/cloud.html){.nav-link}

-   -   [16. Appendix 1: Chapter 1 for Java
        Programmers](../Appendix1/index.html){.nav-link}
        -   [16.1. Getting Started Programming in
            C](../Appendix1/getting_started.html){.nav-link}
        -   [16.2. Input/Output (printf and
            scanf)](../Appendix1/input_output.html){.nav-link}
        -   [16.3. Conditionals and
            Loops](../Appendix1/conditionals.html){.nav-link}
        -   [16.4. Functions](../Appendix1/functions.html){.nav-link}
        -   [16.5. Arrays and
            Strings](../Appendix1/arrays_strings.html){.nav-link}
        -   [16.6. Structs](../Appendix1/structs.html){.nav-link}
        -   [16.7. Summary](../Appendix1/summary.html){.nav-link}
        -   [16.8. Exercises](../Appendix1/exercises.html){.nav-link}

-   -   [17. Appendix 2: Using Unix](../Appendix2/index.html){.nav-link}
        -   [17.1. Unix Command Line and the Unix File
            System](../Appendix2/cmdln_basics.html){.nav-link}
        -   [17.2. Man and the Unix
            Manual](../Appendix2/man.html){.nav-link}
        -   [17.3. Remote Access](../Appendix2/ssh_scp.html){.nav-link}
        -   [17.4. Unix Editors](../Appendix2/editors.html){.nav-link}
        -   [17.5. make and
            Makefiles](../Appendix2/makefiles.html){.nav-link}
        -   [17.6 Searching: grep and
            find](../Appendix2/grep.html){.nav-link}
        -   [17.7 File Permissions](../Appendix2/chmod.html){.nav-link}
        -   [17.8 Archiving and Compressing
            Files](../Appendix2/tar.html){.nav-link}
        -   [17.9 Process Control](../Appendix2/pskill.html){.nav-link}
        -   [17.10 Timing](../Appendix2/timing.html){.nav-link}
        -   [17.11 Command
            History](../Appendix2/history.html){.nav-link}
        -   [17.12 I/0
            Redirection](../Appendix2/ioredirect.html){.nav-link}
        -   [17.13 Pipes](../Appendix2/pipe.html){.nav-link}
        -   [17.14 Dot Files and
            .bashrc](../Appendix2/dotfiles.html){.nav-link}
        -   [17.15 Shell
            Programming](../Appendix2/shellprog.html){.nav-link}
        -   [17.16 Getting System
            Information](../Appendix2/sysinfo.html){.nav-link}



-   [Dive Into Systems](../index-2.html)
-   [2. A Deeper Dive Into C](index.html)
-   [2.9. Advanced C Features](advanced.html)
-   [2.9.6. Writing and using your own C libraries (and compiling
    multiple .c and .h files)](advanced_writing_libraries.html)
:::

::: content
::: sect2
### [](#_c_libraries_){.anchor}2.9.6. Writing and Using Your Own C Libraries {#_c_libraries_}

::: paragraph
Programmers typically divide large C programs into separate **modules**
(i.e., separate `.c` files) of related functionality. Definitions shared
by more than one module are put in header files (`.h` files) that are
included by the modules that need them. Similarly, C library code is
also implemented in one or more modules (`.c` files) and one or more
header files (`.h` files). C programmers often implement their own C
libraries of commonly used functionality. By writing a library, a
programmer implements the functionality once, in the library, and then
can use this functionality in any subsequent C program that they write.
:::

::: paragraph
In the [Using, Compiling, and Linking
Libraries](advanced_libraries.html#_c_link_load_){.page} section, we
describe how to use, compile, and link C library code into C programs.
In this section, we discuss how to write and use your own libraries in
C. What we present here also applies to structuring and compiling larger
C programs composed of multiple C source and header files.
:::

::: paragraph
To create a library in C:
:::

::: {.olist .arabic}
1.  Define an interface to the library in a header (`.h`) file. This
    header file must be included by any program that wants to use the
    library.

2.  Create an implementation of the library in one or more `.c` files.
    This set of function definitions implement the library's
    functionality. Some functions may be interface functions that users
    of the library will call, and others may be internal functions that
    cannot be called by users of the library (internal functions are
    part of good modular design of the library's implementation).

3.  Compile a binary form of the library that can be linked into
    programs that use the library.
:::

::: paragraph
The binary form of a library could be directly built from its source
file(s) as part of compiling the application code that uses the library.
This method compiles the library files into `.o` files and statically
links them into the binary executable. Including libraries this way
often applies to library code that you write for your own use (since you
have access to its `.c` source files), and it's also the method to build
an executable from multiple `.c` modules.
:::

::: paragraph
Alternatively, a library could be compiled into a binary archive (`.a`)
or a shared object (`.so`) file for programs that want to use the
library. In these cases, users of the library often will not have access
to the library's C source code files, and thus they are not able to
directly compile the library code with application code that uses it.
When a program uses such a precompiled library (e.g., a `.a` or `.so`),
the library's code must be explicitly linked into the executable file
using `gcc`\'s `-l` command line option.
:::

::: paragraph
We focus our detailed discussion of writing, compiling, and linking
library code on the case in which the programmer has access to
individual library modules (either the `.c` or `.o` files). This focus
also applies to designing and compiling large C programs that are
divided into multiple `.c` and `.h` files. We briefly show commands for
building archive and shared object forms of libraries. More information
about building these types of library files is available in the `gcc`
documentation, including the man pages for `gcc` and `ar`.
:::

::: sect3
#### [](#_library_details_by_example){.anchor}Library Details by Example {#_library_details_by_example}

::: paragraph
In the following, we show some examples of creating and using your own
libraries.
:::

::: paragraph
**Define the library interface:**
:::

::: paragraph
Header files (`.h` file) are text files that contain C function
prototypes and other definitions --- they represent the interface of a
library. A header file must be included in any application that intends
to use the library. For example, the C standard library header files are
usually stored in `/usr/include/` and can be viewed with an editor:
:::

::: listingblock
::: content
``` {.highlightjs .highlight}
$ vi /usr/include/stdio.h
```
:::
:::

::: paragraph
Here's an [example header file (`mylib.h`)](_attachments/mylib.h) from a
library that contains some definitions for users of the library.
:::

::: listingblock
::: content
``` {.highlightjs .highlight}
#ifndef _MYLIB_H_
#define _MYLIB_H_

// a constant definition exported by library:
#define MAX_FOO  20

// a type definition exported by library:
struct foo_struct {
    int x;
    float y;
};

// a global variable exported by library
// "extern" means that this is not a variable declaration,
// but it defines that a variable named total_times of type
// int exists in the library implementation and is available
// for use by programs using the library.
// It is unusual for a library to export global variables
// to its users, but if it does, it is important that
// extern appears in the definition in the .h file
extern int total_times;

// a function prototype for a function exported by library:
// extern means that this function definition exists
// somewhere else.
/*
 * This function returns the larger of two float values
 *  y, z: the two values
 *  returns the value of the larger one
 */
extern float bigger(float y, float z);

#endif
```
:::
:::

::: paragraph
Header files typically have special \"boilerplate\" code around their
contents:
:::

::: listingblock
::: content
``` {.highlightjs .highlight}
#ifndef

// header file contents

#endif
```
:::
:::

::: paragraph
This boilerplate code ensures that the compiler's preprocessor only
includes the contents of `mylib.h` exactly once in any C file that
includes it. It is important to include `.h` file contents only once to
avoid duplicate definition errors at compile time. Similarly, if you
forget to include a `.h` file in a C program that uses the library, the
compiler will generate an `undefined symbol` warning.
:::

::: paragraph
The comments in the `.h` file are part of the interface to the library,
written for users of the library. These comments should be verbose,
explaining definitions and describing what each library function does,
what parameters values it takes, and what it returns. Sometimes a `.h`
file will also include a top-level comment describing how to use the
library.
:::

::: paragraph
The keyword **extern** before the global variable definition and
function prototype means that these names are defined somewhere else. It
is particularly important to include `extern` before any global
variables that the library exports, as it distinguishes a name and type
definition (in the `.h` file) from a variable declaration in the
library's implementation. In the previous example, the global variable
is declared exactly once inside the library, but it's exported to
library users through its `extern` definition in the library's `.h`
file.
:::

::: paragraph
**Implement the library functionality:**
:::

::: paragraph
Programmers implement libraries in one or more `.c` files (and sometimes
internal `.h` files). The implementation includes definitions of all the
functions\' prototypes in the `.h` file as well as other functions that
are internal to its implementation. These internal functions are often
defined with the keyword `static`, which scopes their availability to
the module (`.c` file) in which they are defined. The library
implementation should also include variable definitions for any `extern`
global variable declarations in the `.h` file. Here's [an example
library implementation (`mylib.c`)](_attachments/mylib.c):
:::

::: listingblock
::: content
``` {.highlightjs .highlight}
#include <stdlib.h>

// Include the library header file if the implementation needs
// any of its definitions (types or constants, for example.)
// Use " " instead of < > if the mylib.h file is not in a
// default  library path with other standard library header
// files (the usual case for library code you write and use.)
#include "mylib.h"

// declare the global variable exported by the library
int total_times = 0;

// include function definitions for each library function:
float bigger(float y, float z) {
    total_times++;
    if (y > z) {
        return y;
    }
    return z;
}
```
:::
:::

::: paragraph
**Create a binary form of the library:**
:::

::: paragraph
To create a binary form of the library (a `.o` file), compile with the
`-c` option:
:::

::: listingblock
::: content
``` {.highlightjs .highlight}
$ gcc -o mylib.o -c mylib.c
```
:::
:::

::: paragraph
One or more `.o` files can build an archive (`.a`) or shared object
(`.so`) version of the library.
:::

::: ulist
-   To build a static library use the archiver (`ar`):
:::

::: listingblock
::: content
``` {.highlightjs .highlight}
ar -rcs libmylib.a mylib.o
```
:::
:::

::: ulist
-   To build a dynamically linked library, the `mylib.o` object file(s)
    in the library must be built with **position independent code**
    (using `-fPIC`). A `libmylib.so` shared object file can be created
    from `mylib.o` by specifying the `-shared` flag to `gcc`:
:::

::: listingblock
::: content
``` {.highlightjs .highlight}
gcc -fPIC -o mylib.o -c mylib.c
gcc -shared -o libmylib.so mylib.o
```
:::
:::

::: ulist
-   Shared object and archive libraries are often built from multiple
    `.o` files, for example (remember that `.o` for dynamically linked
    libraries need to be built using the `-fPIC` flag):
:::

::: listingblock
::: content
``` {.highlightjs .highlight}
gcc -shared -o libbiglib.so file1.o file2.o file3.o file4.o
ar -rcs libbiglib.a file1.o file2.o file3.o file4.o
```
:::
:::

::: paragraph
**Use and link the library:**
:::

::: paragraph
In other `.c` files that use this library:
:::

::: {.olist .arabic}
1.  `#include` its header file, and

2.  explicitly link in the implementation (`.o` file) during
    compilation.
:::

::: paragraph
After including the library header file, your code then can call the
library's functions (e.g., in [`myprog.c`](_attachments/myprog.c)):
:::

::: listingblock
::: content
``` {.highlightjs .highlight}
#include <stdio.h>
#include "mylib.h"   // include library header file

int main(void) {
    float val1, val2, ret;
    printf("Enter two float values: ");
    scanf("%f%f", &val1, &val2);
    ret = bigger(val1, val2);   // use a library function
    printf("%f is the biggest\n", ret);

    return 0;
}
```
:::
:::

::: {.admonitionblock .note}
+-----------------------------------+-----------------------------------+
|                                   | ::: title                         |
|                                   | `#include` syntax and the         |
|                                   | preprocessor                      |
|                                   | :::                               |
|                                   |                                   |
|                                   | ::: paragraph                     |
|                                   | Note that the `#include` syntax   |
|                                   | to include `mylib.h` is different |
|                                   | from the syntax to include        |
|                                   | `stdio.h`. This is because        |
|                                   | `mylib.h` is not located with the |
|                                   | header files from standard        |
|                                   | libraries. The preprocessor has   |
|                                   | default places it looks for       |
|                                   | standard header files. When       |
|                                   | including a file with the         |
|                                   | `<file.h>` syntax instead of the  |
|                                   | `"file.h"` syntax, the            |
|                                   | preprocessor searches for the     |
|                                   | header file in those standard     |
|                                   | places.                           |
|                                   | :::                               |
|                                   |                                   |
|                                   | ::: paragraph                     |
|                                   | When `mylib.h` is included inside |
|                                   | double quotes, the preprocessor   |
|                                   | first looks in the current        |
|                                   | directory for the `mylib.h` file, |
|                                   | and then other places that you    |
|                                   | need to explicitly tell it to     |
|                                   | look, by specifying an include    |
|                                   | path (`-I`) to `gcc`. For         |
|                                   | example, if the header file is in |
|                                   | the `/home/me/myincludes`         |
|                                   | directory (and not in the same    |
|                                   | directory as the `myprog.c`       |
|                                   | file), then the path to this      |
|                                   | directory must be specified in    |
|                                   | the `gcc` command line for the    |
|                                   | preprocessor to find the          |
|                                   | `mylib.h` file:                   |
|                                   | :::                               |
|                                   |                                   |
|                                   | ::: listingblock                  |
|                                   | ::: content                       |
|                                   |     $ gcc                         |
|                                   | -I/home/me/myincludes -c myprog.c |
|                                   | :::                               |
|                                   | :::                               |
+-----------------------------------+-----------------------------------+
:::

::: ulist
-   To compile a program (`myprog.c`) that uses the library (`mylib.o`)
    into a binary executable:

    ::: listingblock
    ::: content
        $ gcc -o myprog myprog.c mylib.o
    :::
    :::

-   Or, if the library's implementation files are available at compile
    time, then the program can be built directly from the program and
    library `.c` files:

    ::: listingblock
    ::: content
        $ gcc -o myprog myprog.c mylib.c
    :::
    :::

-   Or, if the library is available as an archive or shared object file,
    then it can be linked in using `-l`, (`-lmylib`: note that the
    library name is `libmylib.[a,so]`, but only the `mylib` part is
    included in the `gcc` command line):

    ::: listingblock
    ::: content
        $ gcc -o myprog myprog.c -L. -lmylib
    :::
    :::

    ::: paragraph
    The `-L.` option specifies the path to the `libmylib.[so,a]` files
    (the `.` after the `-L` indicates that it should search the current
    directory). By default, `gcc` will dynamically link a library if it
    can find a `.so` version. See the [Using C libraries
    section](advanced_libraries.html#_c_link_load_){.page} for more
    information about linking and link paths.
    :::
:::

::: paragraph
The program can then be run:
:::

::: listingblock
::: content
    $ ./myprog
:::
:::

::: paragraph
If you run the dynamically linked version of `myprog`, you may encounter
an error that looks like this:
:::

::: listingblock
::: content
    /usr/bin/ld: cannot find -lmylib
    collect2: error: ld returned 1 exit status
:::
:::

::: paragraph
This error is saying that the runtime linker cannot find `libmylib.so`
at runtime. To fix this problem, set your `LD_LIBRARY_PATH` environment
variable to include the path to the `libmylib.so` file. Subsequent runs
of `myprog` use the path you add to `LD_LIBRARY_PATH` to find the
`libmylib.so` file and load it at runtime. For example, if `libmylib.so`
is in the `/home/me/mylibs/` subdirectory, run this (just once) at the
bash shell prompt to set the `LD_LIBRARY_PATH` environment variable:
:::

::: listingblock
::: content
    $ export LD_LIBRARY_PATH=/home/me/mylibs:$LD_LIBRARY_PATH
:::
:::
:::
:::

::: toc-menu
:::
:::
:::
:::

Copyright (C) 2020 Dive into Systems, LLC.

*Dive into Systems,* is licensed under the Creative Commons
[Attribution-NonCommercial-NoDerivatives 4.0
International](https://creativecommons.org/licenses/by-nc-nd/4.0/) (CC
BY-NC-ND 4.0).
